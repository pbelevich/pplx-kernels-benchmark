# Perplexity Kernels Benchmark
https://github.com/ppl-ai/pplx-kernels

Updated to NVSHMEM 3.3.9 and PPLX-KERNELS [Jul 16, 2025](https://github.com/ppl-ai/pplx-kernels/commit/1d76f488d794f01dc0e895cd746b235392379757)

## Download NVSHMEM 3.3.9

```
wget https://developer.download.nvidia.com/compute/redist/nvshmem/3.3.9/source/nvshmem_src_cuda12-all-all-3.3.9.tar.gz && tar -xvf nvshmem_src_cuda12-all-all-3.3.9.tar.gz
```

## Building Perplexity Kernels Docker image

```bash
GDRCOPY_VERSION=v2.4.4
EFA_INSTALLER_VERSION=1.42.0
AWS_OFI_NCCL_VERSION=v1.16.0
NCCL_VERSION=v2.27.5-1
NCCL_TESTS_VERSION=v2.16.4
NVSHMEM_VERSION=3.3.9
TAG="efa${EFA_INSTALLER_VERSION}-ofi${AWS_OFI_NCCL_VERSION}-nccl${NCCL_VERSION}-tests${NCCL_TESTS_VERSION}-nvshmem${NVSHMEM_VERSION}"
PPLX_CONTAINER_IMAGE_NAME_TAG="pplx-kernels:${TAG}"
```

```bash
docker build --progress=plain -f ./pplx-kernels.Dockerfile \
       --build-arg="EFA_INSTALLER_VERSION=${EFA_INSTALLER_VERSION}" \
       --build-arg="AWS_OFI_NCCL_VERSION=${AWS_OFI_NCCL_VERSION}" \
       --build-arg="NCCL_VERSION=${NCCL_VERSION}" \
       --build-arg="NCCL_TESTS_VERSION=${NCCL_TESTS_VERSION}" \
       --build-arg="NVSHMEM_VERSION=${NVSHMEM_VERSION}" \
       -t ${PPLX_CONTAINER_IMAGE_NAME_TAG} \
       .
```

```bash
enroot import -o ./pplx-kernels.sqsh dockerd://${PPLX_CONTAINER_IMAGE_NAME_TAG}
```

## Running Perplexity Kernels Benchmark

```bash
sbatch pplx-kernels.sbatch
```

## Check the logs

```bash
tail -f -n +0 slurm-XXX.out
```

## Core dump

1. run `ulimit -c unlimited` and check that `srun -N <num of nodes> bash -c "ulimit -c"` should print `unlimited` <num of nodes> times
2. run `srun -N <num of nodes> sudo bash -c "mkdir -p /tmp/coredump && echo '/tmp/coredump/core.%e.%p' > /proc/sys/kernel/core_pattern"`
3. run `sbatch pplx-kernels.sbatch`

## Example of the output

```
EP=8 DP=8
E       E/tok   tok     dim     Dispatch_lat    Dispatch_bw     Dispatch_bytes  Combine_lat     Combine_bw      Combine_bytes   Torch_lat       Torch_bw        Torch_bytes     NVSHMEM_lat     NVSHMEM_bw      NVSHMEM_bytes
64      6       1       2048    18.8μs ±  3.3μs 0.685GB/s       12672   16.6μs ±  0.7μs 1.486GB/s       24576   22.5μs ±  2.9μs 6.082GB/s       135168  26.8μs ±  1.2μs 5.051GB/s       135168
64      6       4       2048    19.0μs ±  1.0μs 2.680GB/s       50688   15.0μs ±  0.5μs 6.549GB/s       98304   24.7μs ±  5.3μs 22.497GB/s      540672  28.6μs ±  6.4μs 19.420GB/s      540672
64      6       8       2048    19.6μs ±  0.6μs 5.185GB/s       101376  14.7μs ±  0.3μs 13.350GB/s      196608  25.5μs ±  2.5μs 42.846GB/s      1081344 26.6μs ±  1.3μs 40.786GB/s      1081344
64      6       16      2048    21.2μs ±  1.3μs 9.575GB/s       202752  17.0μs ±  1.9μs 23.279GB/s      393216  42.1μs ± 61.1μs 72.788GB/s      2162688 29.3μs ±  6.0μs 75.523GB/s      2162688
64      6       32      2048    27.6μs ±  2.2μs 14.765GB/s      405504  22.7μs ±  1.5μs 34.827GB/s      786432  57.3μs ±  1.9μs 75.556GB/s      4325376 54.7μs ±  1.5μs 79.080GB/s      4325376
64      6       64      2048    34.4μs ±  1.3μs 23.591GB/s      811008  31.1μs ± 21.5μs 57.541GB/s      1572864 52.5μs ± 14.1μs 170.546GB/s     8650752 45.5μs ±  2.3μs 190.326GB/s     8650752
64      6       128     2048    50.8μs ±  3.7μs 32.040GB/s      1622016 40.3μs ±  0.6μs 78.019GB/s      3145728 79.8μs ± 10.2μs 219.285GB/s     17301504        77.5μs ±  2.5μs 223.454GB/s     17301504
256     8       1       7168    18.7μs ±  0.3μs 3.162GB/s       59136   19.5μs ±  0.2μs 5.882GB/s       114688  26.1μs ±  0.4μs 72.575GB/s      1892352 33.4μs ± 34.6μs 70.747GB/s      1892352
256     8       4       7168    21.2μs ±  0.2μs 11.180GB/s      236544  20.2μs ±  0.2μs 22.701GB/s      458752  42.1μs ±  0.4μs 179.634GB/s     7569408 42.1μs ±  0.3μs 179.634GB/s     7569408
256     8       8       7168    24.4μs ±  0.3μs 19.399GB/s      473088  22.3μs ±  0.5μs 41.183GB/s      917504  71.9μs ±  0.7μs 210.691GB/s     15138816        68.1μs ±  0.7μs 222.306GB/s     15138816
256     8       16      7168    25.9μs ±  0.4μs 36.544GB/s      946176  32.0μs ±  0.2μs 57.383GB/s      1835008 114.5μs ±  2.2μs        264.443GB/s     30277632        117.5μs ± 17.0μs        260.961GB/s     30277632
256     8       32      7168    32.7μs ±  0.4μs 57.896GB/s      1892352 41.2μs ±  0.2μs 88.996GB/s      3670016 191.0μs ±  2.0μs        317.143GB/s     60555264        191.2μs ±  0.7μs        316.798GB/s     60555264
256     8       64      7168    43.3μs ±  1.3μs 87.439GB/s      3784704 52.0μs ±  0.6μs 141.120GB/s     7340032 357.4μs ±  1.5μs        338.910GB/s     121110528       355.2μs ±  2.6μs        340.961GB/s     121110528
256     8       128     7168    60.9μs ±  0.8μs 124.235GB/s     7569408 90.6μs ±  2.5μs 162.124GB/s     14680064        674.6μs ±  2.0μs        359.043GB/s     242221056       677.2μs ±  2.7μs        357.662GB/s     242221056
```

```
EP=16 DP=16
E       E/tok   tok     dim     Dispatch_lat    Dispatch_bw     Dispatch_bytes  Combine_lat     Combine_bw      Combine_bytes   Torch_lat       Torch_bw        Torch_bytes     NVSHMEM_lat     NVSHMEM_bw      NVSHMEM_bytes
64      6       1       2048    132.3μs ±  9.6μs        0.096GB/s       12672   127.1μs ± 35.0μs        0.203GB/s       24576   112.5μs ±  6.1μs        1.205GB/s       135168  94.8μs ±  6.8μs 1.433GB/s       135168
64      6       4       2048    277.3μs ± 11.5μs        0.183GB/s       50688   236.3μs ± 12.8μs        0.417GB/s       98304   117.2μs ±  7.5μs        4.630GB/s       540672  107.7μs ±  7.1μs        5.041GB/s       540672
64      6       8       2048    462.6μs ± 12.0μs        0.219GB/s       101376  420.2μs ± 33.7μs        0.470GB/s       196608  129.4μs ± 10.5μs        8.408GB/s       1081344 125.8μs ± 11.3μs        8.663GB/s       1081344
64      6       16      2048    821.0μs ± 19.4μs        0.247GB/s       202752  910.4μs ± 16.7μs        0.432GB/s       393216  153.1μs ±  6.5μs        14.150GB/s      2162688 147.0μs ±  7.5μs        14.748GB/s      2162688
64      6       32      2048    1688.2μs ± 35.9μs       0.240GB/s       405504  1497.4μs ± 45.2μs       0.526GB/s       786432  643.4μs ± 48.5μs        6.759GB/s       4325376 221.7μs ±  6.7μs        19.527GB/s      4325376
64      6       64      2048    3189.0μs ± 55.4μs       0.254GB/s       811008  3403.6μs ± 179.1μs      0.463GB/s       1572864 742.6μs ± 158.1μs       12.121GB/s      8650752 404.6μs ± 10.8μs        21.398GB/s      8650752
64      6       128     2048    5676.7μs ± 66.8μs       0.286GB/s       1622016 6438.1μs ± 223.2μs      0.489GB/s       3145728 1181.7μs ± 222.6μs      15.141GB/s      17301504        566.9μs ± 18.8μs        30.550GB/s      17301504
256     8       1       7168    295.1μs ± 13.3μs        0.201GB/s       59136   314.8μs ±  8.7μs        0.365GB/s       114688  125.5μs ±  6.8μs        15.121GB/s      1892352 148.3μs ±  8.1μs        12.794GB/s      1892352
256     8       4       7168    537.2μs ± 11.5μs        0.440GB/s       236544  351.6μs ± 13.7μs        1.307GB/s       458752  299.3μs ±  8.5μs        25.307GB/s      7569408 301.6μs ±  8.3μs        25.117GB/s      7569408
256     8       8       7168    779.7μs ± 17.7μs        0.607GB/s       473088  465.4μs ± 11.3μs        1.973GB/s       917504  554.9μs ± 10.6μs        27.293GB/s      15138816        549.1μs ±  6.8μs        27.575GB/s      15138816
256     8       16      7168    1401.6μs ± 25.7μs       0.675GB/s       946176  1133.1μs ± 50.6μs       1.622GB/s       1835008 688.6μs ± 25.6μs        44.025GB/s      30277632        643.3μs ± 37.0μs        47.221GB/s      30277632
256     8       32      7168    2508.1μs ± 81.1μs       0.755GB/s       1892352 2277.2μs ± 77.8μs       1.613GB/s       3670016 1223.9μs ± 47.3μs       49.547GB/s      60555264        1176.0μs ± 31.0μs       51.525GB/s      60555264
256     8       64      7168    4647.9μs ± 33.4μs       0.814GB/s       3784704 5148.3μs ± 113.5μs      1.426GB/s       7340032 2125.5μs ± 64.9μs       57.030GB/s      121110528       2153.7μs ± 25.1μs       56.240GB/s      121110528
256     8       128     7168    9150.6μs ± 77.6μs       0.827GB/s       7569408 11121.9μs ± 196.9μs     1.320GB/s       14680064        3376.3μs ± 138.8μs      71.852GB/s      242221056       3563.3μs ± 96.0μs       68.023GB/s      242221056
```

```
EP=32 DP=32
E       E/tok   tok     dim     Dispatch_lat    Dispatch_bw     Dispatch_bytes  Combine_lat     Combine_bw      Combine_bytes   Torch_lat       Torch_bw        Torch_bytes     NVSHMEM_lat     NVSHMEM_bw      NVSHMEM_bytes
64      6       1       2048    198.6μs ± 72.7μs        0.068GB/s       12672   371.2μs ± 476.6μs       0.101GB/s       24576   261.4μs ± 44.5μs        0.527GB/s       135168  233.7μs ± 42.7μs        0.592GB/s       135168
64      6       4       2048    398.7μs ± 10.5μs        0.127GB/s       50688   348.1μs ± 13.3μs        0.283GB/s       98304   232.0μs ± 15.2μs        2.340GB/s       540672  223.2μs ± 10.7μs        2.428GB/s       540672
64      6       8       2048    722.1μs ± 34.5μs        0.141GB/s       101376  597.7μs ± 23.2μs        0.329GB/s       196608  269.5μs ± 28.9μs        4.053GB/s       1081344 226.8μs ± 43.8μs        4.880GB/s       1081344
64      6       16      2048    1369.4μs ± 22.0μs       0.148GB/s       202752  1185.9μs ± 25.0μs       0.332GB/s       393216  199.9μs ± 13.6μs        10.862GB/s      2162688 246.8μs ± 40.2μs        8.924GB/s       2162688
64      6       32      2048    2596.8μs ± 77.3μs       0.156GB/s       405504  2145.0μs ± 96.2μs       0.367GB/s       786432  447.8μs ± 82.3μs        9.976GB/s       4325376 261.9μs ± 12.3μs        16.549GB/s      4325376
64      6       64      2048    5030.9μs ± 64.2μs       0.161GB/s       811008  5412.6μs ± 104.0μs      0.291GB/s       1572864 565.3μs ± 107.0μs       15.842GB/s      8650752 440.9μs ±  7.6μs        19.628GB/s      8650752
64      6       128     2048    8829.8μs ± 88.7μs       0.184GB/s       1622016 10852.8μs ± 166.6μs     0.290GB/s       3145728 1006.8μs ± 148.8μs      17.601GB/s      17301504        857.7μs ± 380.5μs       21.673GB/s      17301504
256     8       1       7168    413.8μs ± 21.0μs        0.143GB/s       59136   395.8μs ±  9.2μs        0.290GB/s       114688  172.3μs ±  6.0μs        10.993GB/s      1892352 229.6μs ±  9.0μs        8.252GB/s       1892352
256     8       4       7168    839.2μs ± 23.7μs        0.282GB/s       236544  490.4μs ± 25.5μs        0.938GB/s       458752  344.5μs ± 41.7μs        22.208GB/s      7569408 326.8μs ± 15.4μs        23.202GB/s      7569408
256     8       8       7168    1325.3μs ± 24.3μs       0.357GB/s       473088  597.7μs ± 39.1μs        1.541GB/s       917504  529.3μs ± 16.8μs        28.629GB/s      15138816        534.6μs ± 18.3μs        28.349GB/s      15138816
256     8       16      7168    2155.0μs ± 42.1μs       0.439GB/s       946176  1529.4μs ± 30.9μs       1.200GB/s       1835008 1188.9μs ± 46.1μs       25.503GB/s      30277632        1110.5μs ± 25.1μs       27.278GB/s      30277632
256     8       32      7168    3943.8μs ± 57.8μs       0.480GB/s       1892352 3627.0μs ± 123.5μs      1.013GB/s       3670016 1375.6μs ± 111.1μs      44.301GB/s      60555264        1367.6μs ± 26.8μs       44.293GB/s      60555264
256     8       64      7168    7085.6μs ± 78.4μs       0.534GB/s       3784704 8693.5μs ± 176.1μs      0.845GB/s       7340032 2736.0μs ± 139.5μs      44.378GB/s      121110528       2708.4μs ± 61.3μs       44.738GB/s      121110528
256     8       128     7168    13428.1μs ± 81.0μs      0.564GB/s       7569408 17494.4μs ± 221.5μs     0.839GB/s       14680064        5472.5μs ± 191.3μs      44.311GB/s      242221056       5103.1μs ± 90.6μs       47.480GB/s      242221056
```

```
EP=64 DP=64
E       E/tok   tok     dim     Dispatch_lat    Dispatch_bw     Dispatch_bytes  Combine_lat     Combine_bw      Combine_bytes   Torch_lat       Torch_bw        Torch_bytes     NVSHMEM_lat     NVSHMEM_bw      NVSHMEM_bytes
64      6       1       2048    446.6μs ± 273.9μs       0.038GB/s       12672   835.5μs ± 519.4μs       0.041GB/s       24576   421.8μs ± 30.9μs        0.322GB/s       135168  443.7μs ± 28.9μs        0.306GB/s       135168
64      6       4       2048    542.6μs ± 67.1μs        0.094GB/s       50688   673.6μs ± 192.6μs       0.156GB/s       98304   449.6μs ± 60.1μs        1.219GB/s       540672  463.3μs ± 29.2μs        1.172GB/s       540672
64      6       8       2048    919.4μs ± 15.3μs        0.110GB/s       101376  872.6μs ± 61.8μs        0.226GB/s       196608  419.6μs ± 53.2μs        2.610GB/s       1081344 513.8μs ± 294.7μs       2.333GB/s       1081344
64      6       16      2048    1762.1μs ± 194.4μs      0.116GB/s       202752  1573.3μs ± 152.0μs      0.252GB/s       393216  535.7μs ± 453.2μs       4.908GB/s       2162688 468.9μs ± 55.5μs        4.661GB/s       2162688
64      6       32      2048    3379.8μs ± 102.0μs      0.120GB/s       405504  3025.5μs ± 147.0μs      0.261GB/s       786432  656.4μs ± 151.6μs       6.902GB/s       4325376 459.8μs ± 27.8μs        9.439GB/s       4325376
64      6       64      2048    6437.1μs ± 37.4μs       0.126GB/s       811008  7375.3μs ± 117.4μs      0.213GB/s       1572864 528.1μs ± 80.0μs        16.733GB/s      8650752 474.7μs ± 14.6μs        18.240GB/s      8650752
64      6       128     2048    11611.7μs ± 56.5μs      0.140GB/s       1622016 14204.2μs ± 306.0μs     0.222GB/s       3145728 1525.3μs ± 297.1μs      11.764GB/s      17301504        888.7μs ± 27.5μs        19.486GB/s      17301504
256     8       1       7168    460.6μs ± 31.8μs        0.129GB/s       59136   565.7μs ± 17.9μs        0.203GB/s       114688  402.8μs ± 19.1μs        4.708GB/s       1892352 452.4μs ± 24.8μs        4.195GB/s       1892352
256     8       4       7168    1137.7μs ± 30.3μs       0.208GB/s       236544  653.6μs ± 18.5μs        0.702GB/s       458752  448.9μs ± 26.1μs        16.914GB/s      7569408 493.5μs ± 28.2μs        15.390GB/s      7569408
256     8       8       7168    1742.7μs ± 34.8μs       0.272GB/s       473088  902.9μs ± 54.4μs        1.019GB/s       917504  606.5μs ± 31.9μs        25.025GB/s      15138816        570.0μs ± 16.5μs        26.580GB/s      15138816
256     8       16      7168    2782.8μs ± 39.6μs       0.340GB/s       946176  2197.5μs ± 59.6μs       0.836GB/s       1835008 787.3μs ± 53.9μs        38.628GB/s      30277632        1023.7μs ± 23.5μs       29.591GB/s      30277632
256     8       32      7168    4904.7μs ± 51.8μs       0.386GB/s       1892352 5282.4μs ± 121.3μs      0.695GB/s       3670016 2304.3μs ± 84.9μs       26.313GB/s      60555264        2253.5μs ± 50.2μs       26.884GB/s      60555264
256     8       64      7168    9139.2μs ± 73.5μs       0.414GB/s       3784704 11348.3μs ± 168.3μs     0.647GB/s       7340032 3200.6μs ± 170.4μs      37.941GB/s      121110528       3206.9μs ± 79.3μs       37.788GB/s      121110528
256     8       128     7168    17421.4μs ± 91.9μs      0.435GB/s       7569408 23192.7μs ± 392.0μs     0.633GB/s       14680064        6409.9μs ± 310.8μs      37.872GB/s      242221056       6165.0μs ± 184.5μs      39.323GB/s      242221056
```
